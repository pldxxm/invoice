name: Deploy to AWS ubuntu EC2 instance

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: aws-ec2

    env: # ← Declare env variables here
      REMOTE_HOST: ${{ secrets.EC2_PUBLIC_IP }}
      REMOTE_USER: ubuntu
      # EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
      TOKEN: ${{ secrets.TOKEN }}
      PORT: 3000
      tag: v1.2

    steps:
      # - name: Checkout code
      #   uses: actions/checkout@v4

      # - name: Setup Node.js
      #   uses: actions/setup-node@v4.4.0
      #   with:
      #     node-version: 20.11.1

      # - name: Install CSS build dependencies
      #   run: npm install postcss postcss-cli tailwindcss autoprefixer

      # - name: Build Css
      #   run: npm run buildcss

      - name: test env
        run: |
          echo "REMOTE_HOST: ${{ env.REMOTE_HOST }}"
          echo "REMOTE_USER: ${{ env.REMOTE_USER }}"
          echo "MONGODB_URI: ${{ env.MONGODB_URI }}"
          echo "SESSION_SECRET: ${{ env.SESSION_SECRET }}"
          echo "PORT: ${{ env.PORT }}"
          echo "EC2_PUBLIC_IP: ${{ secrets.EC2_PUBLIC_IP }}"

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1.0.0 # ← Different action
        with:
          host: ${{ env.REMOTE_HOST }}
          username: ${{ env.REMOTE_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            cd /home/ubuntu

            # Set git user name and email
            git config --global  user.name "pldxxm"
            git config --global  user.email "pldxxm@example.com"

            #Clone or update repository (using token authentication)
            if [ ! -d "invoice" ]; then
              echo "Repository not found, cloning..."
              sudo git clone https://${{ env.TOKEN }}@github.com/pldxxm/invoice.git
            else
              echo "Repository exists, pulling latest changes..."
              cd invoice
              # Update remote URL to use token
              sudo git remote set-url origin https://${{ env.TOKEN }}@github.com/pldxxm/invoice.git
              sudo git pull origin main
              cd ..
            fi

            # Check and install Node.js 20.11.1
            if ! command -v node &> /dev/null || [[ "$(node --version)" != "v20.11.1" ]]; then
              echo "Installing Node.js 20.11.1..."
              curl -fsSL https://deb.nodesource.com/setup_20.x | sudo -E bash -
              sudo apt-get install -y nodejs
            fi

            # Check and install PM2
            if ! command -v pm2 &> /dev/null; then
              echo "Installing PM2..."
              sudo npm install -g pm2
            fi

            MONGODB_URI="${{ env.MONGODB_URI }}"
            SESSION_SECRET="${{ env.SESSION_SECRET }}"
            PORT="${{ env.PORT }}"

            # Create .env file
            sudo tee .env > /dev/null << EOF
              NODE_ENV=production
              MONGODB_URI=$MONGODB_URI
              SESSION_SECRET=$SESSION_SECRET
              PORT=$PORT
            EOF

            cd invoice

            sudo npm install --production 
            sudo npm run buildcss
            pm2 restart index.js || pm2 start index.js
